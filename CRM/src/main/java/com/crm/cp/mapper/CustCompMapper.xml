<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="custcomp">
   
   <!-- 전체 리스트 가져오기 - [페이징] -->
	<select id="custcompList" parameterType="java.util.Map" resultType="com.crm.cp.sales.custcomp.vo.CustCompVO">
    select r.*, rnum
	          from (select 
			          rownum rnum
			          , c.cust_id cust_id
          			   , c.cust_nm cust_nm
                       , c.cust_zip_cd cust_zip_cd
                       , c.cust_addr cust_addr
                       , c.cust_dtl_addr cust_dtl_addr 
                       , (select cd.cd_nm from code cd where cd.cd_grp_id = 'CDC' and cd.code = c.cust_div_cd) cust_div_nm
          			   , c.comp_num comp_num
                       , c.corp_num corp_num
          			   , (select cd.cd_nm from code cd where cd.cd_grp_id = 'SSC' and cd.code = c.sales_scale_cd ) sales_scale
                       , c.homepage_url homepage_url
          			   , (select cd.cd_nm from code cd where cd.cd_grp_id = 'IDC' and cd.code = c.indst_cd ) indst
                       , c.biz_status biz_status 
                       , c.main_prod main_prod 
          			   , c.emp_qty emp_qty
                       , c.rep_ph1 rep_ph1
          			   , c.rep_ph2 rep_ph2
          			   , c.rep_ph3 rep_ph3
          			   , TO_CHAR(c.fst_reg_dt, 'YYYY-MM-DD hh:mm') fst_reg_dt
          			from customer c		   
                    where 1=1
                    and c.act_yn = 'Y'   
                    <choose>
						<when test="sch_cust_nm !=null and sch_cust_nm !='' and sch_cust_nm0 != null and sch_cust_nm0 != '' and sch_cust_nm1 != null and sch_cust_nm1 != ''">
							and (c.cust_nm like '%'||#{sch_cust_nm}||'%' 
								 or c.cust_nm like '%'||#{sch_cust_nm0}||'%' 
								 or c.cust_nm like '%'||#{sch_cust_nm1}||'%')
						</when>
						<when test="sch_cust_nm !=null and sch_cust_nm !='' and sch_cust_nm0 != null and sch_cust_nm0 != ''">
							and (c.cust_nm like '%'||#{sch_cust_nm}||'%' 
								 or c.cust_nm like '%'||#{sch_cust_nm0}||'%')
		 				</when>
						<when test="sch_cust_nm !=null and sch_cust_nm !=''">
							and c.cust_nm like '%'||#{sch_cust_nm}||'%'
						</when>
					</choose>
					<choose>
						<when test="sch_comp_num !=null and sch_comp_num !='' and sch_comp_num0 != null and sch_comp_num0 != '' and sch_comp_num1 != null and sch_comp_num1 != ''">
							and (c.comp_num like '%'||#{sch_comp_num} ||'%' 
								 or c.comp_num like '%'||#{sch_comp_num0} ||'%' 
								 or c.comp_num like '%'||#{sch_comp_num1}||'%' )
						</when>
						<when test="sch_comp_num !=null and sch_comp_num !='' and sch_comp_num0 != null and ssch_comp_num0 != ''">
							and (c.comp_num like '%'||#{sch_comp_num} ||'%' 
								 or c.comp_num like '%'||#{sch_comp_num0}||'%' )
						</when>
						<when test="sch_comp_num !=null and sch_comp_num !='' ">
							and c.comp_num like '%'|| #{sch_comp_num}||'%' 
						</when>
					</choose>
					<choose>
						<when test="sch_corp_num !=null and sch_corp_num !='' and sch_corp_num0 != null and sch_corp_num0 != '' and sch_corp_num1 != null and sch_corp_num1 != ''">
							and (c.corp_num like '%'||{sch_corp_num}||'%' 
								or c.corp_num like '%'||#{sch_corp_num0} ||'%' 
								or c.corp_num like '%'||#{sch_corp_num1}||'%' )
						</when>
						<when test="sch_corp_num !=null and sch_comp_num !='' and sch_corp_num0 != null and sch_corp_num0 != ''">
							and (c.corp_num like '%'||#{sch_corp_num} ||'%' 
								 or c.corp_num like '%'|| #{sch_corp_num0}||'%' )
						</when>
						<when test="sch_corp_num !=null and sch_corp_num !='' ">
							and c.corp_num like '%'|| #{sch_corp_num}||'%' 
						</when>
					</choose>
	                order by c.fin_mdfy_dt  desc
           		) r
       	 <![CDATA[where rnum >= ]]>	#{page.startRow} and rnum <![CDATA[ <= ]]>#{page.endRow}
 
	</select>
	
	<!-- 고객사 삭제된 데이터 리스트 -->
	<select id="custcompDelList" parameterType="java.util.Map" resultType="com.crm.cp.sales.custcomp.vo.CustCompVO">
		    select r.*, rnum
	          from (select 
			          rownum rnum
			          , c.cust_id cust_id
          			   , c.cust_nm cust_nm
                       , c.cust_zip_cd cust_zip_cd
                       , c.cust_addr cust_addr
                       , c.cust_dtl_addr cust_dtl_addr 
                       , (select cd.cd_nm from code cd where cd.cd_grp_id = 'CDC' and cd.code = c.cust_div_cd) cust_div_nm
          			   , c.comp_num comp_num
                       , c.corp_num corp_num
          			   , (select cd.cd_nm from code cd where cd.cd_grp_id = 'SSC' and cd.code = c.sales_scale_cd ) sales_scale
                       , c.homepage_url homepage_url
          			   , (select cd.cd_nm from code cd where cd.cd_grp_id = 'IDC' and cd.code = c.indst_cd ) indst
                       , c.biz_status biz_status 
                       , c.main_prod main_prod 
          			   , c.emp_qty emp_qty
                       , c.rep_ph1 rep_ph1
          			   , c.rep_ph2 rep_ph2
          			   , c.rep_ph3 rep_ph3
          			   , c.fin_mdfy_id
          			   , TO_CHAR(c.fin_mdfy_dt, 'YYYY-MM-DD hh:mm') fin_mdfy_dt
          			   , c.fst_reg_id
          			   , TO_CHAR(c.fst_reg_dt, 'YYYY-MM-DD hh:mm') fst_reg_dt
          			from customer c		   
                    where 1=1
                    and c.act_yn = 'N'   
                    <choose>
						<when test="sch_cust_nm !=null and sch_cust_nm !='' and sch_cust_nm0 != null and sch_cust_nm0 != '' and sch_cust_nm1 != null and sch_cust_nm1 != ''">
							and (c.cust_nm like '%'||#{sch_cust_nm}||'%' 
								 or c.cust_nm like '%'||#{sch_cust_nm0}||'%' 
								 or c.cust_nm like '%'||#{sch_cust_nm1}||'%')
						</when>
						<when test="sch_cust_nm !=null and sch_cust_nm !='' and sch_cust_nm0 != null and sch_cust_nm0 != ''">
							and (c.cust_nm like '%'||#{sch_cust_nm}||'%' 
								 or c.cust_nm like '%'||#{sch_cust_nm0}||'%')
		 				</when>
						<when test="sch_cust_nm !=null and sch_cust_nm !=''">
							and c.cust_nm like '%'||#{sch_cust_nm}||'%'
						</when>
					</choose>
					<choose>
						<when test="sch_comp_num !=null and sch_comp_num !='' and sch_comp_num0 != null and sch_comp_num0 != '' and sch_comp_num1 != null and sch_comp_num1 != ''">
							and (c.comp_num like '%'||#{sch_comp_num} ||'%' 
								 or c.comp_num like '%'||#{sch_comp_num0} ||'%' 
								 or c.comp_num like '%'||#{sch_comp_num1}||'%' )
						</when>
						<when test="sch_comp_num !=null and sch_comp_num !='' and sch_comp_num0 != null and ssch_comp_num0 != ''">
							and (c.comp_num like '%'||#{sch_comp_num} ||'%' 
								 or c.comp_num like '%'||#{sch_comp_num0}||'%' )
						</when>
						<when test="sch_comp_num !=null and sch_comp_num !='' ">
							and c.comp_num like '%'|| #{sch_comp_num}||'%' 
						</when>
					</choose>
					<choose>
						<when test="sch_corp_num !=null and sch_corp_num !='' and sch_corp_num0 != null and sch_corp_num0 != '' and sch_corp_num1 != null and sch_corp_num1 != ''">
							and (c.corp_num like '%'||{sch_corp_num}||'%' 
								or c.corp_num like '%'||#{sch_corp_num0} ||'%' 
								or c.corp_num like '%'||#{sch_corp_num1}||'%' )
						</when>
						<when test="sch_corp_num !=null and sch_comp_num !='' and sch_corp_num0 != null and sch_corp_num0 != ''">
							and (c.corp_num like '%'||#{sch_corp_num} ||'%' 
								 or c.corp_num like '%'|| #{sch_corp_num0}||'%' )
						</when>
						<when test="sch_corp_num !=null and sch_corp_num !='' ">
							and c.corp_num like '%'|| #{sch_corp_num}||'%' 
						</when>
					</choose>
	                order by c.fin_mdfy_dt desc
           		) r
       	 <![CDATA[where rnum >= ]]>	#{page.startRow} and rnum <![CDATA[ <= ]]>#{page.endRow}
	</select>
	
	<!-- 고객사 리스트 개수 -->
	<select id="ccListTotalCount" parameterType="java.util.Map" resultType="int">
<!-- 	select nvl(count(c.cust_id), 0)  -->
<!-- 		from customer c -->
<!--     		where 1=1 -->
<!--                   and c.act_yn = 'Y' -->
<!-- 				<if test="sch_cust_nm != null and sch_cust_nm !=''"> -->
<!-- 			     	and c.cust_nm like '%'||#{sch_cust_nm}||'%' -->
<!-- 			    </if> -->
<!-- 			    <if test="sch_comp_num != null and sch_comp_num !=''"> -->
<!-- 			     	and c.comp_num like '%'||#{sch_comp_num}||'%' -->
<!-- 			    </if>  -->
<!-- 			    <if test="sch_corp_num != null and sch_corp_num !=''"> -->
<!-- 			     	and c.corp_num like '%'||#{sch_corp_num}||'%' -->
<!-- 			    </if> -->
<!-- 		  order by c.fst_reg_dt desc -->
	select nvl(count(cust_id), 0) 
		from (select 
		          rownum rnum
		          , c.cust_id cust_id
         			   , c.cust_nm cust_nm
                      , c.cust_zip_cd cust_zip_cd
                      , c.cust_addr cust_addr
                      , c.cust_dtl_addr cust_dtl_addr 
                      , (select cd.cd_nm from code cd where cd.cd_grp_id = 'CDC' and cd.code = c.cust_div_cd) cust_div_nm
         			   , c.comp_num comp_num
                      , c.corp_num corp_num
         			   , (select cd.cd_nm from code cd where cd.cd_grp_id = 'SSC' and cd.code = c.sales_scale_cd ) sales_scale
                      , c.homepage_url homepage_url
         			   , (select cd.cd_nm from code cd where cd.cd_grp_id = 'IDC' and cd.code = c.indst_cd ) indst
                      , c.biz_status biz_status 
                      , c.main_prod main_prod 
         			   , c.emp_qty emp_qty
                      , c.rep_ph1 rep_ph1
         			   , c.rep_ph2 rep_ph2
         			   , c.rep_ph3 rep_ph3
         			   , TO_CHAR(c.fst_reg_dt, 'YYYY-MM-DD hh:mm') fst_reg_dt
         			from customer c		   
                   where 1=1)
	</select>
	
	<!-- 기업고객 상세정보 -->
	<select id="custCompDetail" parameterType="String" resultType="com.crm.cp.sales.custcomp.vo.CustCompVO">
		select 
			c.cust_id cust_id
          	, c.cust_nm cust_nm
            , c.cust_zip_cd cust_zip_cd
            , c.cust_addr cust_addr
            , c.cust_dtl_addr cust_dtl_addr 
            , c.cust_div_cd cust_div_cd
          	, c.comp_num comp_num
            , c.corp_num corp_num
          	, (select cd.cd_nm from code cd where cd.cd_grp_id = 'SSC' and cd.code = c.sales_scale_cd ) sales_scale_cd
            , c.homepage_url homepage_url
          	, (select cd.cd_nm from code cd where cd.cd_grp_id = 'IDC' and cd.code = c.indst_cd ) indst_cd
            , c.biz_status biz_status 
            , c.main_prod main_prod 
          	, c.emp_qty emp_qty
            , c.rep_ph1 rep_ph1
          	, c.rep_ph2 rep_ph2
          	, c.rep_ph3 rep_ph3
	   from customer c
       where c.cust_id = #{cust_id}
		    and c.cust_div_cd = '0001'
		    and c.act_yn = 'Y'
	</select>
	
	<!-- 고객사 상세정보 -->
	<select id="custcompDetail" parameterType="String" resultType="com.crm.cp.sales.custcomp.vo.CustCompVO">
		select c.cust_id cust_id
		      , c.cust_nm cust_nm
		      , c.cust_div_cd cust_div_cd
		      , c.comp_num comp_num
 		      , c.corp_num corp_num
 		      , c.rep_ph1 rep_ph1
		      , c.rep_ph2 rep_ph2
		      , c.rep_ph3 rep_ph3
		      , c.homepage_url homepage_url
		      , c.cust_zip_cd cust_zip_cd
		      , c.cust_addr cust_addr
		      , c.cust_dtl_addr cust_dtl_addr
		      , c.sales_scale_cd sales_scale_cd
		      , c.emp_qty emp_qty
		      , c.indst_cd indst_cd
		      , c.biz_status biz_status
		      , c.main_prod main_prod
		 from customer c
       where c.cust_id = #{cust_id}
		  and c.cust_div_cd = '0001'
		  and c.act_yn = 'Y'
	</select>
	
	<!-- 고객사 삭제된 데이터 상세정보 -->
	<select id="custcompDelDetail" parameterType="String" resultType="com.crm.cp.sales.custcomp.vo.CustCompVO">
		select 
<!-- 			  c.cust_id cust_id -->
<!-- 		      , c.cust_nm cust_nm -->
<!-- 		      , c.cust_div_cd cust_div_cd -->
<!-- 		      , c.comp_num comp_num -->
<!--  		      , c.corp_num corp_num -->
<!--  		      , c.rep_ph1 rep_ph1 -->
<!-- 		      , c.rep_ph2 rep_ph2 -->
<!-- 		      , c.rep_ph3 rep_ph3 -->
<!-- 		      , c.homepage_url homepage_url -->
<!-- 		      , c.cust_zip_cd cust_zip_cd -->
<!-- 		      , c.cust_addr cust_addr -->
<!-- 		      , c.cust_dtl_addr cust_dtl_addr -->
<!-- 		      , c.sales_scale_cd sales_scale_cd -->
<!-- 		      , c.emp_qty emp_qty -->
<!-- 		      , c.indst_cd indst_cd -->
<!-- 		      , c.biz_status biz_status -->
<!-- 		      , c.main_prod main_prod -->
			
			*
			
		 from customer c
       	 where c.cust_id = #{cust_id}
		  	and c.cust_div_cd = '0001'
		  	and c.act_yn = 'N'
	</select>
	
	<!-- 고객사 추가 -->
	<update  id="custcompInsert" parameterType="com.crm.cp.sales.custcomp.vo.CustCompVO">
		INSERT INTO CUSTOMER (
  			CUST_ID, CUST_NM, CUST_DIV_CD,  COMP_NUM,  CORP_NUM,  REP_PH1,  REP_PH2,  REP_PH3,  HOMEPAGE_URL,  CUST_ZIP_CD,   CUST_ADDR,   CUST_DTL_ADDR,
  			SALES_SCALE_CD,  EMP_QTY,  INDST_CD,  BIZ_STATUS,  MAIN_PROD,  FST_REG_ID,   FST_REG_DT,  FIN_MDFY_ID,   FIN_MDFY_DT,   ACT_YN ) 
		VALUES (
  			(SELECT 
		     	DECODE(MAX(cust_id), NULL, 'CUS0000001', 'CUS' || lpad( (SUBSTR(MAX(cust_id), 4, 7) + 1), 7, 0))
		     from CUSTOMER
		     WHERE ROWNUM=1),
  			#{cust_nm, jdbcType=VARCHAR}, 
  			#{cust_div_cd, jdbcType=VARCHAR},
  			#{comp_num, jdbcType=VARCHAR},
 			#{corp_num, jdbcType=VARCHAR},
 			#{rep_ph1, jdbcType=VARCHAR},
  			#{rep_ph2, jdbcType=VARCHAR},
 			#{rep_ph3, jdbcType=VARCHAR},
  			#{homepage_url, jdbcType=VARCHAR},
  			#{cust_zip_cd, jdbcType=VARCHAR},
  			#{cust_addr, jdbcType=VARCHAR},
  			#{cust_dtl_addr, jdbcType=VARCHAR},
  			#{sales_scale_cd, jdbcType=VARCHAR},
  			#{emp_qty, jdbcType=VARCHAR},
  			#{indst_cd, jdbcType=VARCHAR},
  			#{biz_status, jdbcType=VARCHAR},
  			#{main_prod, jdbcType=VARCHAR},
  			'admin',
  			sysdate,
  			#{fin_mdfy_id},
 			sysdate, 
  			'Y'
		)
	</update>
	
	<!-- 고객사 수정 -->
	<update id="custcompEdit" parameterType="com.crm.cp.sales.custcomp.vo.CustCompVO">
		update CUSTOMER 
		set 
			cust_nm = #{cust_nm, jdbcType=VARCHAR}
		  , cust_div_cd = #{cust_div_cd, jdbcType=VARCHAR}
		  , comp_num = #{comp_num, jdbcType=VARCHAR}
 		  , corp_num = #{corp_num, jdbcType=VARCHAR}
 		  , rep_ph1 = #{rep_ph1, jdbcType=VARCHAR}
		  , rep_ph2 = #{rep_ph2, jdbcType=VARCHAR}
		  , rep_ph3 = #{rep_ph3, jdbcType=VARCHAR}
		  , homepage_url = #{homepage_url, jdbcType=VARCHAR}
		  , cust_zip_cd = #{cust_zip_cd, jdbcType=VARCHAR}
		  , cust_addr  = #{cust_addr, jdbcType=VARCHAR}
		  , cust_dtl_addr = #{cust_dtl_addr, jdbcType=VARCHAR}
		  , sales_scale_cd = #{sales_scale_cd, jdbcType=VARCHAR}
		  , emp_qty = #{emp_qty, jdbcType=VARCHAR}
		  , indst_cd = #{indst_cd, jdbcType=VARCHAR}
		  , biz_status = #{biz_status, jdbcType=VARCHAR}
		  
	   where cust_id = #{cust_id}
	</update>
	
	<!-- 고객사 삭제된 데이터 복원(수정) -->
	<update id="custcompDelEdit" parameterType="com.crm.cp.sales.custcomp.vo.CustCompVO">
		update CUSTOMER
		set
			act_yn = 'Y',
			fin_mdfy_id = #{fin_mdfy_id},
			fin_mdfy_dt = sysdate
		where cust_id = #{cust_id}
	</update>

	<!-- 고객사 삭제 -->
	<update id="custcompDelete" parameterType="com.crm.cp.sales.custcomp.vo.CustCompVO">
		update CUSTOMER 
		set act_yn = 'N',
			fin_mdfy_id = #{fin_mdfy_id},
			fin_mdfy_dt = sysdate
		where cust_id = #{cust_id}
	</update>
	
	<!-- 고객사 삭제시 영업기회 삭제 -->
	<update id="custcompOpptDel" parameterType="com.crm.cp.sales.oppt.vo.OpptVO">
		update SALES_OPPORTUNITY 
		set 
			act_yn = 'N',
			fin_mdfy_id = #{fin_mdfy_id},
			fin_mdfy_dt = sysdate
		where cust_id = #{cust_id}
	</update>
	
	<!-- 고객사 삭제시 영업활동 삭제 -->
	<update id="custcompActDel" parameterType="com.crm.cp.sales.act.vo.ActVO">
		update SALES_ACTIVITY 
		set 
			act_yn = 'N',
			fin_mdfy_id = #{fin_mdfy_id},
			fin_mdfy_dt = sysdate
		where cust_id = #{cust_id}
	</update>
	
	<!-- 고객사 삭제된 영업기회 복원 -->
	<update id="custcompOpptRb" parameterType="com.crm.cp.sales.oppt.vo.OpptVO">
		update SALES_OPPORTUNITY 
		set 
			act_yn = 'Y',
			fin_mdfy_id = #{fin_mdfy_id},
			fin_mdfy_dt = sysdate
		where cust_id = #{cust_id}
	</update>
	
	<!-- 고객사 삭제된 영업활동 복원 -->
	<update id="custcompActRb" parameterType="com.crm.cp.sales.act.vo.ActVO">
		update SALES_ACTIVITY 
		set 
			act_yn = 'Y',
			fin_mdfy_id = #{fin_mdfy_id},
			fin_mdfy_dt = sysdate
		where cust_id = #{cust_id}
	</update>
	
	<!-- 고객사 삭제된 데이터 완전 삭제 -->
	<delete id="custcompDelDelete" parameterType="com.crm.cp.sales.custcomp.vo.CustCompVO">
		delete 
		from customer 
		where cust_id = #{cust_id}
	</delete>
	
	<!-- 산업군 코드 리스트 -->
	<select id="getIDC" resultType="com.crm.cp.sales.custcomp.vo.CustCompVO">
		select code indst_cd, cd_nm indst from code where cd_grp_id = 'IDC'
	</select>
	
	<!-- 매출규모 코드 리스트 -->
	<select id="getSSC" resultType="com.crm.cp.sales.custcomp.vo.CustCompVO">
		select code sales_scale_cd, cd_nm sales_scale from code where cd_grp_id = 'SSC'
	</select>
	
	<!-- 기업상태 코드 리스트 -->
	<select id="getCCS" resultType="com.crm.cp.sales.custcomp.vo.CustCompVO">
		select code stat_cd, cd_nm stat from code where cd_grp_id = 'CCS'
	</select>
	
	<!-- 고객사구분 코드 리스트 -->
	<select id="getCDC" resultType="com.crm.cp.sales.custcomp.vo.CustCompVO">
		select 
			cd_grp_id cust_div_id 
			, code cust_div_cd
			, cd_nm cust_div_nm
		from code 
		where cd_grp_id = 'CDC'
	</select>
	
	
	<!-- 영업 담당자 리스트(고객사담당자에서 바뀐 이름) -->
	<select id="pocList" parameterType="String" resultType="com.crm.cp.sales.custcomp.vo.PocVO">
		select 
			cust.cust_id,
			cust.cust_nm,
			i.iuser_id,
			i.iuser_nm,
			org.org_nm,
			poc.key_part,
			i.cell_ph1,
			i.cell_ph2,
			i.cell_ph3,
			i.email1,
			i.email2,
			i.FST_REG_DT,
			i.FIN_MDFY_DT
		from PARTNER_OF_CLIENT poc, iuser i, CUSTOMER cust, ORGANIZATION org
		where 1=1
		    and cust.cust_id = poc.cust_id
		    and i.iuser_id = poc.iuser_id
		    and i.org_id = org.org_id
		    and cust.cust_id = #{cust_id} 
		order by i.FST_REG_DT desc, i.FIN_MDFY_DT desc
	</select>
	
	<!-- 영업 담당자 리스트(삭제) -->
	<select id="posList" parameterType="String" resultType="com.crm.cp.sales.custcomp.vo.PosVO">
		select 
        	(select SALES_ACTVY_ID from SALES_ACTIVITY sa where sa.SALES_ACTVY_ID = pos.SALES_ACTVY_ID ) sales_actvy_id,
        	(select SALES_ACTVY_NM from SALES_ACTIVITY sa where sa.SALES_ACTVY_ID = pos.SALES_ACTVY_ID ) sales_actvy_nm,
			(select iuser_id from iuser i where i.iuser_id = pos.iuser_id ) iuser_id,
			(select iuser_nm from iuser i where i.iuser_id = pos.iuser_id ) iuser_nm,
			
			pos.key_part,
			pos.fst_reg_id,
			TO_CHAR(pos.FST_REG_DT, 'YYYY-MM-DD hh:mm') FST_REG_DT
		from SALES_ACTIVITY sa, 
			 PARTNER_OF_SALESACT pos, 
			 customer cust
		where sa.SALES_ACTVY_ID = pos.SALES_ACTVY_ID
		and sa.cust_id = cust.cust_id
		and sa.cust_id = #{cust_id} 
	</select>
	
	<!-- 영업 담당자 상세보기 -->
	<select id="posDetail" parameterType="map" resultType="com.crm.cp.sales.custcomp.vo.PosVO">
		select 
        	(select SALES_ACTVY_ID from SALES_ACTIVITY sa where sa.SALES_ACTVY_ID = pos.SALES_ACTVY_ID ) sales_actvy_id,
        	(select SALES_ACTVY_NM from SALES_ACTIVITY sa where sa.SALES_ACTVY_ID = pos.SALES_ACTVY_ID ) sales_actvy_nm,
      		(select iuser_id from iuser i where i.iuser_id = pos.iuser_id ) iuser_id,     
			(select iuser_nm from iuser i where i.iuser_id = pos.iuser_id ) iuser_nm,
		      cust.cust_id,
		      cust.cust_nm,
		      pos.key_part,
			  pos.fst_reg_id,
			  TO_CHAR(pos.FST_REG_DT, 'YYYY-MM-DD hh:mm') FST_REG_DT
		from SALES_ACTIVITY sa, 
			 PARTNER_OF_SALESACT pos, 
			 customer cust
		where sa.SALES_ACTVY_ID = pos.SALES_ACTVY_ID
		and sa.cust_id = cust.cust_id
		and cust.cust_id = #{cust_id}
		and pos.iuser_id = #{iuser_id}
<!-- 		and pos.SALES_ACTVY_ID = #{sales_actvy_id} -->
	</select>
	
	<!-- 영업 담당자 추가 -->
	<update id="posListAdd" parameterType="com.crm.cp.sales.custcomp.vo.PosVO">
		 insert into PARTNER_OF_SALESACT
		 (
			  SALES_ACTVY_ID,
			  iuser_id,
			  key_part,
			  fst_reg_id,
			  fst_reg_dt
		 )
		 	values
		 (
			  #{sales_actvy_id, jdbcType=VARCHAR},
			  #{iuser_id, jdbcType=VARCHAR},
			  #{key_part, jdbcType=VARCHAR},
			  'admin',
			  sysdate
			 
		 )	
	</update>
	
	
	 <!-- 영업활동 전체 리스트 -->
	<select id="actList" parameterType="java.util.Map" resultType="com.crm.cp.sales.act.vo.ActVO">
		SELECT SAL.* 
		FROM
			(
				SELECT P.*, ROWNUM RNUM 
				FROM 
					(
						SELECT 
            
							  SA.SALES_ACTVY_ID
	             			, SA.SALES_ACTVY_NM 
							,(SELECT C.cd_nm FROM code C WHERE C.cd_grp_id = 'ATC' AND C.code = SA.SALES_ACTVY_TYPE_CD) SALES_ACTVY_TYPE_CD
							,(SELECT C.cd_nm FROM code C WHERE C.cd_grp_id = 'ASC' AND C.code = SA.SALES_ACTVY_STAT_CD)SALES_ACTVY_STAT_CD
							,SO.SALES_OPPT_NM
	             				,CUST.CUST_ID
						FROM 
							SALES_ACTIVITY SA, SALES_OPPORTUNITY SO, CUSTOMER CUST
						WHERE 
							SA.SALES_OPPT_ID=SO.SALES_OPPT_ID(+)
							AND CUST.CUST_ID = SA.CUST_ID
              				AND CUST.CUST_ID = #{cust_id}
             				AND SA.ACT_YN = 'Y'
						ORDER BY SA.FST_REG_DT DESC
					) P
			) SAL
               
	</select>
	
	<select id="userSelect" parameterType="string" resultType="map">
		SELECT *
		FROM IUSER
		WHERE ACT_YN='Y';
	</select>
	
	
	<!-- 영업담당자 수정 -->
	<update id="custSaleActUpdate" parameterType="com.crm.cp.sales.custcomp.vo.PosVO">
	      update PARTNER_OF_SALESACT
		  set   
		        key_part = #{key_part, jdbcType=VARCHAR}
		  WHERE SALES_ACTVY_ID = #{sales_actvy_id, jdbcType=VARCHAR}
		  and iuser_id = #{iuser_id, jdbcType=VARCHAR}
	</update>
	
	<!-- 영업담당자 삭제 -->
	<delete id="custSaleActDelete" parameterType="com.crm.cp.sales.custcomp.vo.PosVO">
	      delete from PARTNER_OF_SALESACT
		  where SALES_ACTVY_ID = #{sales_actvy_id, jdbcType=VARCHAR}
		  and iuser_id = #{iuser_id, jdbcType=VARCHAR}
	</delete>
	
	<!-- 키맨 리스트 -->
	<select id="keymanList" parameterType="String" resultType="com.crm.cp.sales.custcomp.vo.KeymanVO">
		select	    
			k.CUST_ID,
			k.CONT_ID,
          	con.cont_nm,
			k.KEY_PART,
			k.KEY_POS, 
			con.cell_ph1,
          	con.cell_ph2,
          	con.cell_ph3,
          	con.email1,
          	con.email2,
			k.FST_REG_ID,
			k.FST_REG_DT,
			k.FIN_MDFY_ID,
			k.FIN_MDFY_DT
		FROM KEYMAN k, customer cust, contact con
	    WHERE cust.cust_id  = #{cust_id} 
	   		 and k.cont_id = con.cont_id 
      		 and k.cust_id = cust.cust_id
	</select>
	
 	<!-- 키맨 추가 -->
	<insert id="addKeyman" parameterType="com.crm.cp.sales.custcomp.vo.KeymanVO">
		 INSERT INTO KEYMAN 
		 (
		 	CUST_ID, 
		 	CONT_ID, 
		 	KEY_PART, 
		 	KEY_POS,  
		 	FST_REG_ID, 
		 	FST_REG_DT, 
		 	FIN_MDFY_ID, 
		 	FIN_MDFY_DT
		 ) 
	     VALUES
	     ( 
	     	#{cust_id}, 
	     	#{cont_id}, 
	     	#{key_part}, 
	     	#{key_pos},   
	     	#{fst_reg_id}, 
	     	sysdate, 
	     	'admin', 
	     	sysdate
	     )
	</insert>
	
 	<!-- 키맨 상세정보 -->
	<select id="kmDetail" parameterType="java.util.Map" resultType="com.crm.cp.sales.custcomp.vo.KeymanVO">
		  SELECT 
        		k.CUST_ID,
				k.CONT_ID,
	      		con.cont_nm,
				k.KEY_PART,
				k.KEY_POS, 
				con.cell_ph1,
        		con.cell_ph2,
	      		con.cell_ph3,
	      		con.email1,
	      		con.email2,
				k.FST_REG_ID,
				k.FST_REG_DT,
				k.FIN_MDFY_ID,
				k.FIN_MDFY_DT
		 FROM KEYMAN k, customer c, CONTACT con
	     WHERE 1=1 
        	and k.cust_id = c.cust_id
        	and k.cont_id = con.cont_id 
       		and k.cust_ID = #{cust_id}
       		and k.cont_id = #{cont_id}
	</select>
	
	<!-- 키맨 삭제 -->
	<delete id="keymanDelete" parameterType="com.crm.cp.sales.custcomp.vo.KeymanVO">
		<!-- update KEYMAN 
		set ACT_YN = 'N'
		where KMN_ID = #{keyman_idList} -->
		delete keyman
		where cont_id =#{cont_id} and cust_id =#{cust_id}
	</delete>
	
	<!-- 키맨 수정 -->
	<update id="mdfyKeyman" parameterType="com.crm.cp.sales.custcomp.vo.KeymanVO">
 		update KEYMAN 
		set KEY_PART = #{key_part},
			 KEY_POS = #{key_pos}, 
			 MEMO = #{memo},
			 FIN_MDFY_ID = #{fin_mdfy_id},
			 FIN_MDFY_DT = sysdate
		where CUST_ID = #{cust_id} and cont_id = #{cont_id}
 	</update>
	
	<!-- 연락처 리스트 -->
 	<select id="contactListPop" resultType="com.crm.cp.sales.contact.vo.ContactVO">
	     select *
		from contact
	</select>
	
	<!-- 영업기회 리스트 -->
	<select id="ccOpptList" parameterType="String" resultType="com.crm.cp.sales.oppt.vo.OpptVO">
		select so.sales_oppt_id,
				so.sales_oppt_nm,
				(select c.cd_nm from code c where c.cd_grp_id = 'OTL' and c.CODE = so.sales_lev_cd) sales_lev_cd_nm ,
				so.expt_sales_amt,
				TO_CHAR(so.expt_fin_d, 'YYYY-MM-DD') expt_fin_d,
				so.psblty_rate,
				(select c.cd_nm from code c where c.cd_grp_id = 'OSC' and c.CODE = so.sales_oppt_stat_cd) sales_oppt_stat_cd_nm ,
				so.fst_reg_id,
				TO_CHAR(so.fst_reg_dt, 'YYYY-MM-DD hh:mm') fst_reg_dt  
		from sales_opportunity so 
	  where cust_id = #{cust_id} 
	        and act_yn = 'Y'
	   ORDER BY so.sales_oppt_id DESC
	</select>
	
	<!-- 영업기회 고객정보 가져오기 -->
	<select id="ccOpptCustDetail" parameterType="String" resultType="com.crm.cp.sales.oppt.vo.OpptVO">
		SELECT 
			c.CUST_NM, 
			l.LEAD_ID 
		FROM CUSTOMER c, LEAD l 
		WHERE c.CUST_ID = l.CUST_ID 
			and c.CUST_ID = #{cust_id} 
			and c.ACT_YN = 'Y'
	</select>
	
	<!-- 영업기회 상세정보 가져오기 -->
	<select id="ccOpptDetail" parameterType="String" resultType="com.crm.cp.sales.oppt.vo.OpptVO">
		select  a.sales_oppt_id
				, a.lead_id
				, a.cust_id
				, c.cust_nm
				, a.sales_oppt_nm
				, (select cd_nm from code where cd_grp_id='OTL' and code=a.sales_lev_cd) sales_lev_cd_nm
				, a.sales_lev_cd
				, a.sales_oppt_stat_cd
				, a.expt_sales_amt
				, TO_CHAR(a.expt_fin_d, 'YYYY-MM-DD') expt_fin_d
				, a.psblty_rate
				, (select cd_nm from code where cd_grp_id='OSC' and code=a.sales_oppt_stat_cd) sales_oppt_stat_cd_nm
				, a.memo
				, a.fst_reg_id
				, a.fst_reg_dt
				, a.fin_mdfy_id
				, a.fin_mdfy_dt
				, a.act_yn
		from sales_opportunity a, lead b, customer c
		where a.lead_id=b.lead_id and b.cust_id=c.cust_id and a.act_yn='Y'
		and a.sales_oppt_id=#{sales_oppt_id}
	</select>
	
	<!-- 영업기회 삭제 -->
	<update id="ccOpptDelete" parameterType="com.crm.cp.sales.oppt.vo.OpptVO">
		update sales_opportunity 
		set ACT_YN = 'N'
		where sales_oppt_id = #{oppt_idList}
	</update>
	 
	<!-- 영업활동유형코드 리스트 -->
	<select id="actTypeCdList" resultType="com.crm.cp.sales.act.vo.ActVO">
		SELECT CODE sales_actvy_type_cd, CD_NM sales_actvy_type_nm FROM CODE WHERE
		CD_GRP_ID='ATC'
	</select>

	<!-- 영업상태코드 리스트 -->
	<select id="actStatCdList" resultType="com.crm.cp.sales.act.vo.ActVO">
		SELECT CODE sales_actvy_stat_cd, CD_NM sales_actvy_stat_nm FROM CODE WHERE
		CD_GRP_ID='ASC'
	</select>

	<!-- 영업구분코드 리스트 -->
	<select id="actDivCdList" resultType="com.crm.cp.sales.act.vo.ActVO">
	SELECT CODE sales_actvy_div_cd, CD_NM sales_actvy_div_nm FROM CODE
	WHERE CD_GRP_ID='ADC'
	</select>
	 
	 <!-- 영업활동 리스트 -->
	<select id="ccActList" parameterType="String" resultType="com.crm.cp.sales.act.vo.ActVO">
	 	SELECT SA.SALES_ACTVY_ID sales_actvy_id
	 			, SA.SALES_ACTVY_NM sales_actvy_nm
    		    , (SELECT C.cd_nm FROM code C WHERE C.cd_grp_id = 'ATC' AND C.code = SA.SALES_ACTVY_TYPE_CD) sales_actvy_type_nm
    		    , TO_CHAR(SA.STRT_D ,'YYYY-MM-DD') strt_d
    		    , SA.STRT_T strt_t
    		    , TO_CHAR(SA.END_D ,'YYYY-MM-DD') end_d
    		    , SA.END_T end_t
    		    , (SELECT C.cd_nm FROM code C WHERE C.cd_grp_id = 'ASC' AND C.code = SA.SALES_ACTVY_STAT_CD) sales_actvy_stat_nm
    		    , SA.FST_REG_ID fst_reg_id
    		    , TO_CHAR(SA.FST_REG_DT,'YYYY-MM-DD hh:mm') fst_reg_dt
    		    , SO.SALES_OPPT_NM sales_oppt_nm
 	   FROM SALES_ACTIVITY SA, SALES_OPPORTUNITY SO
	   WHERE SA.CUST_ID = #{cust_id}
       	  AND SA.SALES_OPPT_ID = SO.SALES_OPPT_ID(+)
  		  AND SA.ACT_YN = 'Y'
  		  ORDER BY SA.SALES_ACTVY_ID DESC
	</select>
	
	<!-- 영업활동 고객정보 -->
	<select id="ccActCustDetail" parameterType="String" resultType="com.crm.cp.sales.act.vo.ActVO">
		select cust_id, cust_nm from customer where cust_id = #{cust_id}
	</select>
	
	<select id="actDetail" parameterType="String" resultType="com.crm.cp.sales.act.vo.ActVO">
		SELECT SA.SALES_ACTVY_ID 
	            ,SA.SALES_ACTVY_NM 
				,SALES_ACTVY_TYPE_CD
				,TO_CHAR(SA.STRT_D ,'YYYY-MM-DD') STRT_D 
				,SA.STRT_T 
				,TO_CHAR(SA.END_D ,'YYYY-MM-DD') END_D 
				,SA.END_T
				,SALES_ACTVY_STAT_CD
			    ,SA.FST_REG_ID ,SA.FIN_MDFY_ID, SA.FST_REG_DT
			    ,SO.SALES_OPPT_ID
			    ,SO.SALES_OPPT_NM
			    ,C.CUST_ID
	            ,C.CUST_NM
	      FROM SALES_ACTIVITY SA, SALES_OPPORTUNITY SO, CUSTOMER C
		  WHERE SA.SALES_ACTVY_ID = #{sales_actvy_id}
	      AND SA.SALES_OPPT_ID=SO.SALES_OPPT_ID(+)
	      AND SA.CUST_ID = C.CUST_ID(+)
		  AND SA.ACT_YN = 'Y'
	</select>
	
	<!-- 영업활동 추가 -->
	<update id="actListAdd" parameterType="com.crm.cp.sales.custcomp.vo.CustActVO" >
		INSERT INTO SALES_ACTIVITY
		(
			SALES_ACTVY_ID,
		    SALES_ACTVY_NM, 
		   
		    SALES_ACTVY_TYPE_CD, 
		    SALES_OPPT_ID, CUST_ID,
			SALES_ACTVY_STAT_CD, 
		    STRT_D, 
		    STRT_T,
		    END_D, END_T, 
			FST_REG_ID,
		    FIN_MDFY_ID
		  )
		  VALUES
		  (
			 (SELECT 
		     		DECODE(MAX(SALES_ACTVY_ID), NULL, 'SAT0000001', 'SAT' || lpad( (SUBSTR( MAX( SALES_ACTVY_ID ), 4, 7 ) + 1), 7, 0)) SALES_ACTVY_ID
		      FROM SALES_ACTIVITY
		      WHERE ROWNUM=1),
			  #{sales_actvy_nm, jdbcType=VARCHAR},
		      #{sales_actvy_div_cd, jdbcType=VARCHAR},
		      #{sales_actvy_type_cd, jdbcType=VARCHAR},
		      #{sales_oppt_id, jdbcType=VARCHAR},
			  #{cust_id, jdbcType=VARCHAR},
		      #{sales_actvy_stat_cd, jdbcType=VARCHAR},
		      TO_DATE(#{strt_d},'yyyy-MM-dd'),
		      #{strt_t},
		      TO_DATE(#{end_d},'yyyy-MM-dd'),
		      #{end_t},
		      #{fst_reg_id, jdbcType=VARCHAR},
		      #{fin_mdfy_id, jdbcType=VARCHAR}
		    )
		    
	</update>	
	
	<!-- 영업활동 수정 -->
	<update id="custActiveUpdate" parameterType="com.crm.cp.sales.act.vo.ActVO">
	      UPDATE SALES_ACTIVITY 
		  SET SALES_ACTVY_NM =#{sales_actvy_nm}
			 
			  , SALES_ACTVY_TYPE_CD=#{sales_actvy_type_cd}
			  , SALES_OPPT_ID=#{sales_oppt_id}
			  , CUST_ID=#{cust_id} 
	          , SALES_ACTVY_STAT_CD=#{sales_actvy_stat_cd}
	          , STRT_D= TO_DATE(#{strt_d},'yyyy-MM-dd')
	          , STRT_T=#{strt_t}, END_D= TO_DATE(#{end_d},'yyyy-MM-dd')
	          , END_T=#{end_t}
	          , FIN_MDFY_DT=sysdate
	          , FIN_MDFY_ID=#{fin_mdfy_id}
		  WHERE SALES_ACTVY_ID = #{sales_actvy_id}
	</update>
	
	<!-- 영업활동 삭제 -->
	<update id="ccActDelete" parameterType="String">
	      UPDATE SALES_ACTIVITY
	      SET ACT_YN = 'N'
	      WHERE SALES_ACTVY_ID = #{sales_actvy_id}
	</update>
	
	<!-- 견적 리스트 -->
	<select id="estimList" parameterType="String" resultType="com.crm.cp.sales.est.vo.EstVO">
		  select 
		      est.estim_id,	
		      est.cust_id,
		      (select cust_nm from customer cust where cust.cust_id = est.cust_id ) cust_nm,
		      est.estim_nm,
		      (SELECT c.cd_nm FROM CODE c where c.cd_grp_id='ELC' and c.code = est.estim_lev_cd ) estim_lev_cd_nm,    
		      estList.estim_qty,
		      estList.sales_price,
		      est.memo,   
		      estList.estim_qty,
		      estList.sales_price,
		      est.memo,   
		      TO_CHAR(est.estim_valid_d, 'YYYY-MM-DD hh:mm') estim_valid_d,
		      est.fst_reg_id,
		      TO_CHAR(est.fst_reg_dt, 'YYYY-MM-DD hh:mm') fst_reg_dt
		  from ESTIMATE est, ESTIMATE_LIST estList
		  where cust_id = #{cust_id}
		      and est.estim_id = estList.estim_id 
		      and est.act_yn = 'Y'
		  order by fst_reg_dt desc
	</select>
	
	<!-- 계약 리스트 -->
	<select id="ccContList" parameterType="String" resultType="com.crm.cp.sales.cont.vo.contrVO">
		SELECT cont.CONTR_ID contr_id
				, cont.CONTR_NM contr_nm
				, cont.CONTR_NUM contr_num
				, cont.CONTR_QTY contr_qty
				, cont.CONTR_AMT contr_amt
				, TO_CHAR(cont.CONTR_D, 'YYYY-MM-DD') contr_d
				, cont.FST_REG_ID fst_reg_id
				, TO_CHAR(cont.FST_REG_DT, 'YYYY-MM-DD hh:mm') fst_reg_dt
		 FROM CONTRACT cont
   				, CUSTOMER cu
	   WHERE cu.CUST_ID = cont.CUST_ID
  		  AND cont.CUST_ID = #{cust_id}
  		  AND cont.ACT_YN = 'Y'
  		  ORDER BY cont.CONTR_ID DESC
	</select>
	
	<!-- 직원 리스트 개수 -->
	<select id="empListNum" parameterType="String" resultType="int">
		SELECT nvl(count(i.IUSER_ID), 0) emp_count
  		 FROM IUSER i, EMPLOYEE e
 	   WHERE i.IUSER_ID = e.IUSER_ID
     	  AND i.IUSER_NM LIKE '%'||#{iuser_nm}||'%'
	</select>
	
	<!-- 직원 리스트 -->
	<select id="empList" parameterType="java.util.Map" resultType="com.crm.cp.sales.custcomp.vo.CustCompVO">
		select r.*
		from (select b.*
               , rownum rnum
	          from (SELECT i.id_nm iuser_id
						      , i.iuser_nm iuser_nm
						      , (SELECT c.cd_nm FROM CODE c WHERE c.CD_GRP_ID = 'EMP' AND c.CODE = e.EMP_CD) emp_cd_nm
						      , (SELECT c.cd_nm FROM CODE c WHERE c.CD_GRP_ID = 'WRK' AND c.CODE = e.WORK_STAT_CD) work_stat_cd_nm
						      , i.COMP_PH1
						      , i.COMP_PH2
						      , i.COMP_PH3
                  , o.ORG_NM
					   FROM IUSER i, EMPLOYEE e, ORGANIZATION o
				     WHERE 1=1
             			and i.iuser_id != 'IU00001'
				     	AND i.IUSER_ID = e.IUSER_ID
             			AND i.ORG_ID = o.ORG_ID
						AND i.iuser_nm LIKE '%'||#{iuser_nm}||'%'
	                ) b
           		) r <![CDATA[where r.rnum>=#{startRow} and r.rnum<=#{endRow}]]>
	</select>
	
	<!-- 계약 기업고객 정보 가져오기 -->
	<select id="ccContCustDetail" parameterType="String" resultType="com.crm.cp.sales.cont.vo.contrVO">
		select cust_nm from customer where cust_id = #{cust_id}
	</select>
	
	<!-- 해당 고객의 영업기회 리스트 -->
	<select id="ccOpptPopList" resultType="com.crm.cp.sales.oppt.vo.OpptVO" parameterType="String">
	   SELECT  DISTINCT SO.SALES_OPPT_ID
				, CT.CUST_ID
				, SO.SALES_OPPT_NM
				, (SELECT C.CD_NM FROM CODE C WHERE C.CD_GRP_ID='OTL' AND C.CODE = SO.SALES_LEV_CD) SALES_LEV_CD
				, SO.EXPT_SALES_AMT
				, TO_CHAR(SO.EXPT_FIN_D, 'YYYY-MM-DD') EXPT_FIN_D
				, SO.PSBLTY_RATE
				, (SELECT C.CD_NM FROM CODE C WHERE C.CD_GRP_ID='OSC' AND C.CODE = SO.SALES_OPPT_STAT_CD) SALES_OPPT_STAT_CD
				, SO.FST_REG_ID
				, SO.FST_REG_DT
		FROM SALES_OPPORTUNITY SO, SALES_OPPORTUNITY_ESTIMATE SOE, LEAD L, CUSTOMER CT, ESTIMATE E, CODE C
		WHERE CT.CUST_ID= #{cust_id} 
		AND E.ESTIM_LEV_CD = '0002'
		AND SO.SALES_OPPT_STAT_CD = '0001'
<!--  	    AND SO.LEAD_ID=L.LEAD_ID  -->
		AND L.CUST_ID=CT.CUST_ID
		AND SO.SALES_OPPT_ID = SOE.SALES_OPPT_ID(+)
		AND SO.ACT_YN='Y'
  		ORDER BY SO.SALES_OPPT_ID
	</select>
	
	<select id="elcList" resultType="com.crm.cp.sales.est.vo.EstVO">
		select 
		CD_NM, 
		CODE 
		from code 
		WHERE CD_GRP_ID = 'ELC'
	</select>
	
	<select id="eduList" resultType="com.crm.cp.sales.est.vo.EstVO">
	  	select 
		CD_NM, 
		CODE 
		from code 
		WHERE CD_GRP_ID = 'EDU'
	</select>
	
	<select id="custEstimDetail" resultType="com.crm.cp.sales.est.vo.EstVO" parameterType="String">
		select 
			a.estim_id,
			a.ESTIM_NM,
			c.CUST_ID,
			d.CUST_NM,
			a.ESTIM_LEV_CD,
			c.SALES_OPPT_NM,
			to_char(a.ESTIM_VALID_D,'YYYY-MM-DD') ESTIM_VALID_D, 
			a.memo,
			c.sales_oppt_id, 
			c.sales_oppt_nm
		from ESTIMATE a,
			 SALES_OPPORTUNITY_ESTIMATE b, 
			 SALES_OPPORTUNITY c, 
			 CUSTOMER d
		where a.ESTIM_ID=b.ESTIM_ID
			and b.SALES_OPPT_ID=c.SALES_OPPT_ID
			and c.CUST_ID=d.CUST_ID
			and a.ESTIM_ID=#{estim_id}
	</select>
	
	<select id="custEstimProdList" resultType="com.crm.cp.sales.est.vo.EstVO" parameterType="String">
		select 
			a.prod_id,
			b.PROD_NM,
			estim_qty,
			sales_price,
			discount,
			sup_price,
			a.discount_unit_cd,
			b.prod_price
		from ESTIMATE_LIST a,
			 PRODUCT b
		where a.PROD_ID=b.PROD_ID
			and a.estim_id=#{estim_id}
			and a.act_yn='Y'
	</select>
	
	<!-- 	상품 목록 조회 -->
	<select id="prodList"  resultType="com.crm.cp.standard.prod.vo.ProdVO" >
		select 
			prod_id,
			prod_nm,
			prod_price
		from product
		<where>
		<if test="keyfield=='pt_id'">
			AND prod_id LIKE '%' || #{keyword} || '%'
		</if>
		<if test="keyfield=='pt_nm'">
			AND prod_nm LIKE '%' || #{keyword} || '%'
		</if>
		</where>
	</select>
	
	<update id="estimateAdd" parameterType="com.crm.cp.sales.est.vo.EstVO">
		insert into ESTIMATE
		(
			estim_id,
			cust_id,
			estim_nm,
			estim_lev_cd,
			estim_valid_d,
			memo,
			fst_reg_id,
			fst_reg_dt,
			fin_mdfy_id,
			fin_mdfy_dt
		)
		values
		(
			(SELECT /*+INDEX_DESC(ESTIMATE PK_ESTIMATE)*/
			 	DECODE(MAX(ESTIM_ID),NULL,'EST0000001','EST'||lpad((SUBSTR(MAX(ESTIM_ID),4,7)+1),7,0))ESTIM_ID
			FROM ESTIMATE
			 WHERE ROWNUM=1)
			,#{cust_id}
			,#{estim_nm}
			,#{estim_lev_cd}
			,TO_DATE(#{estim_valid_d},'yyyy-MM-dd')
			,#{memo}
			,'admin'
			,sysdate
			,'admin'
			,sysdate
		)
		<selectKey keyProperty="estim_seq" resultType="String" order="AFTER">
			SELECT /*+INDEX_DESC(ESTIMATE PK_ESTIMATE)*/
			    ESTIM_ID
			FROM ESTIMATE
			WHERE ROWNUM=1
		</selectKey>
	</update>
	
	<update id="estimateListAdd" parameterType="com.crm.cp.sales.est.vo.EstVO">
		insert into ESTIMATE_LIST
		(
			estim_id,
			prod_id,
			estim_qty,
			sales_price,
			discount,
			sup_price,
			discount_unit_cd
		)
		values
		(
		  #{estim_seq},
		  #{prod_id},
		  #{estim_qty},
		  #{sales_price},
		  #{discount},
		  #{sup_price},
		  #{discount_unit_cd}
		)
	</update>
	
	<update id="soeAdd" parameterType="com.crm.cp.sales.est.vo.EstVO">
		insert into SALES_OPPORTUNITY_ESTIMATE
		(
			estim_id,
			sales_oppt_id,
			fst_reg_id,
			fst_reg_dt,
			fin_mdfy_id,
			fin_mdfy_dt,
			serial_num
		)
		values
		(
		  #{estim_seq},
		  #{sales_oppt_id},
		  'admin',
		   sysdate,
		  'admin',
		   sysdate,
		  (SELECT /*+INDEX_DESC(SALES_OPPORTUNITY_ESTIMATE SERIAL_NUM)*/
			 DECODE(MAX(SERIAL_NUM),NULL,'OES0000001','OES'||lpad((SUBSTR(MAX(SERIAL_NUM),4,7)+1),7,0))SERIAL_NUM
			FROM SALES_OPPORTUNITY_ESTIMATE
			WHERE ROWNUM=1)
		)
	</update>
	
	<update id="estimateDelete" parameterType="String">
		update estimate
		set act_yn='N'
		where estim_id=#{estim_id}
	</update>
	
	<update id="estListDelete" parameterType="String">
		delete from estimate_list
		where estim_id=#{estim_id}
	</update>
</mapper>